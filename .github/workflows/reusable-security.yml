name: Reusable Security Scans

on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version'
        required: false
        type: string
        default: '20'
      run-semgrep:
        description: 'Run Semgrep SAST'
        required: false
        type: boolean
        default: true
      run-npm-audit:
        description: 'Run npm audit SCA'
        required: false
        type: boolean
        default: true
      run-snyk:
        description: 'Run Snyk scan (requires SNYK_TOKEN secret)'
        required: false
        type: boolean
        default: false
      run-sbom:
        description: 'Run SBOM generation'
        required: false
        type: boolean
        default: false
      run-license-check:
        description: 'Run license compliance check'
        required: false
        type: boolean
        default: false
      working-directory:
        description: 'Working directory for monorepo support'
        required: false
        type: string
        default: '.'
      semgrep-rules:
        description: 'Semgrep rulesets (space-separated)'
        required: false
        type: string
        default: 'p/security-audit p/owasp-top-ten p/javascript p/typescript p/nodejs'

jobs:
  semgrep:
    name: SAST (Semgrep)
    runs-on: ubuntu-latest
    if: ${{ inputs.run-semgrep }}
    container:
      image: semgrep/semgrep
    steps:
      - uses: actions/checkout@v4

      - name: Run Semgrep
        run: |
          semgrep scan \
            --config ${{ inputs.semgrep-rules }} \
            --error \
            --verbose \
            ${{ inputs.working-directory }}
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

  npm-audit:
    name: SCA (npm audit)
    runs-on: ubuntu-latest
    if: ${{ inputs.run-npm-audit }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ inputs.working-directory }}

      - name: Audit critical vulnerabilities
        run: npm audit --audit-level=critical --omit=dev
        working-directory: ${{ inputs.working-directory }}

      - name: Full audit (informational)
        continue-on-error: true
        run: |
          echo "## npm audit report" >> $GITHUB_STEP_SUMMARY
          npm audit --omit=dev 2>&1 | tail -20 >> $GITHUB_STEP_SUMMARY || true
        working-directory: ${{ inputs.working-directory }}

  snyk:
    name: SCA (Snyk)
    runs-on: ubuntu-latest
    if: ${{ inputs.run-snyk }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ inputs.working-directory }}

      - name: Run Snyk
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: >
            --severity-threshold=high
            --file=${{ inputs.working-directory }}/package.json

  sbom:
    name: SBOM Generation
    runs-on: ubuntu-latest
    if: ${{ inputs.run-sbom }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@v0

      - name: Generate CycloneDX SBOM
        run: syft dir:${{ inputs.working-directory }} -o cyclonedx-json=sbom-cyclonedx.json

      - name: Generate SPDX SBOM
        run: syft dir:${{ inputs.working-directory }} -o spdx-json=sbom-spdx.json

      - name: Upload SBOMs
        uses: actions/upload-artifact@v4
        with:
          name: sbom-reports
          path: sbom-*.json
          retention-days: 90

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    if: ${{ inputs.run-license-check }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
          cache-dependency-path: ${{ inputs.working-directory }}/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: ${{ inputs.working-directory }}

      - name: Check licenses
        run: |
          npx license-checker --json --out license-report.json || true
          COPYLEFT=$(jq -r 'to_entries[] | select(.value.licenses | test("GPL|AGPL|LGPL")) | .key' license-report.json 2>/dev/null | wc -l || echo "0")

          if [ "$COPYLEFT" -gt 0 ]; then
            echo "## Copyleft licenses detected" >> $GITHUB_STEP_SUMMARY
            jq -r 'to_entries[] | select(.value.licenses | test("GPL|AGPL|LGPL")) | "\(.key): \(.value.licenses)"' license-report.json >> $GITHUB_STEP_SUMMARY
          else
            echo "No copyleft licenses detected" >> $GITHUB_STEP_SUMMARY
          fi
        working-directory: ${{ inputs.working-directory }}

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [semgrep, npm-audit, snyk, sbom, license-check]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Semgrep SAST | ${{ needs.semgrep.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| npm audit | ${{ needs.npm-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Snyk | ${{ needs.snyk.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM | ${{ needs.sbom.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| License Check | ${{ needs.license-check.result }} |" >> $GITHUB_STEP_SUMMARY
